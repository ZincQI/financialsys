# 中小企业财务管理系统后端开发计划

#### 1. 项目初始化 (Project Initialization)

* 创建 Flask 项目基础结构

* 初始化 **Git 仓库** (新增)

* 配置虚拟环境 (venv)

* 设置数据库连接 (SQLAlchemy + PyMySQL)

#### 2. 目录结构设计 (优化版)

*新增了* *`schemas`* *用于数据校验，`commands`* *用于数据初始化*

Plaintext

```
financialsys/
├── app/
│   ├── __init__.py             # App Factory, 注册蓝图, 数据库, 迁移工具
│   ├── models/                 # [DB Layer] 数据库模型 (SQLAlchemy)
│   │   ├── base.py             # 基础模型类(含通用字段如 created_at)
│   │   ├── account.py
│   │   ├── transaction.py
│   │   ├── split.py
│   │   ├── vendor.py
│   │   ├── purchase_order.py
│   │   └── order_entry.py
│   ├── schemas/                # [Validation Layer] Pydantic 模型 (新增!)
│   │   ├── __init__.py
│   │   ├── transaction_schemas.py  # 定义 TransactionCreateDTO 等
│   │   ├── account_schemas.py
│   │   └── report_schemas.py
│   ├── services/               # [Service Layer] 核心业务逻辑
│   │   ├── __init__.py
│   │   ├── transaction_service.py
│   │   ├── report_service.py
│   │   ├── purchase_service.py
│   │   └── account_service.py      # 专门处理科目树逻辑
│   ├── routes/                 # [Controller Layer] API 路由
│   │   ├── __init__.py
│   │   ├── account_routes.py
│   │   ├── transaction_routes.py
│   │   └── report_routes.py
│   └── utils/
│       ├── __init__.py
│       ├── error_handler.py
│       ├── math_utils.py       # 专门处理 分子/分母 <-> Decimal 转换 (新增!)
│       └── serializers.py      # JSON 序列化工具
├── migrations/                 # Flask-Migrate 迁移文件
├── commands/                   # CLI 命令脚本 (新增!)
│   └── seed.py                 # 初始化会计科目树脚本
├── tests/                      # 测试用例
│   ├── conftest.py             # Pytest 配置
│   ├── unit/                   # 单元测试 (测算法)
│   └── integration/            # 集成测试 (测 API)
├── requirements.txt
├── .env
└── run.py

```

#### 3. 核心开发步骤 (详细执行流)

##### 3.1 基础架构搭建

* 安装依赖：`Flask`, `SQLAlchemy`, `PyMySQL`, `Flask-Migrate`, `pydantic`, `python-dotenv`.

* 配置 SQLAlchemy 和 Flask-Migrate。

* 封装 `utils/math_utils.py`：实现 `decimal_to_fraction(amount)` 和 `fraction_to_decimal(num, denom)`，确保全局数学计算标准统一。

##### 3.2 数据模型层 (Models)

* 实现 `BaseModel`：包含 `created_at`, `updated_at`。

* 实现所有 Entity 类：务必设置 `cascade` (级联) 属性，例如删除 Transaction 时级联删除 Splits。

* **关键点**：在 `Split` 模型中，添加一个 `@property` 方法 `amount`，自动调用工具类将分子分母转为 Decimal 返回，方便业务层调用。

##### 3.3 数据校验层 (Schemas) - *新增步骤*

* 定义 `TransactionCreateSchema`：

  * 校验 `splits` 列表长度 >= 2。

  * 校验 `post_date` 格式。

* 定义 `AccountCreateSchema`：

  * 校验 `type` 枚举值合法性。

##### 3.4 业务逻辑层 (Services) - *关键难点*

* **AccountService**：

  * 实现 `get_tree()`：递归构建 JSON 树。

  * 实现 `create_account()`：检查父科目是否存在。

  * 实现 `delete_account()`：**检查**该科目下是否有交易？是否有子科目？如果有，禁止删除。

* **TransactionService**：

  * 实现 `validate_balance()`：调用 `math_utils` 计算借贷差额，必须严格为 0。

  * 实现 `post_transaction()`：使用 `db.session.begin_nested()` 或标准事务块，确保原子性。

* **ReportService**：

  * 实现递归汇总逻辑：复用 `AccountService` 的树结构逻辑，叠加金额计算。

##### 3.5 API 接口层 (Routes)

* 使用 Pydantic schema 验证前端发来的 JSON。

* 调用 Service 处理业务。

* 捕获 Service 抛出的自定义异常（如 `AccountingError`），返回 HTTP 400。

##### 3.6 初始化数据 (Seeding)

* 编写 `commands/seed.py`：

  * 创建一套标准的会计科目模板（资产、负债、权益、收入、费用 5 大根节点）。

  * 创建常用子科目（银行存款、应收账款、主营业务收入等）。

  * *理由：没有这个，前端运行起来是一片空白，无法测试。*

#### 4. 测试策略 (Testing)

* **单元测试 (Unit Tests)**：重点测试 `math_utils` 的精度转换，以及 `TransactionService` 的借贷平衡校验逻辑（故意传入不平的数，断言抛出异常）。

* **集成测试 (Integration Tests)**：模拟一个完整的 API 调用流程：新建科目 -> 录入凭证 -> 查看报表，验证数据流转正确性。

#### 5. 部署准备

* 配置 Gunicorn 启动脚本。

* Docker 容器化配置 (`Dockerfile`, `docker-compose.yml`)。

***

